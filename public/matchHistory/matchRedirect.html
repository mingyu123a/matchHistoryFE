<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="../main.css" rel="stylesheet">
    <link href="../matchHistory/matchHistory.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="../login.js"></script>
    <script src="../riotAPI.js"></script>
    <script>
        // 상수 정의
        const API_BASE_URL = 'https://asia.api.riotgames.com/lol/match/v5/matches/';
        const CHAMPION_IMAGE_URL = 'https://ddragon.leagueoflegends.com/cdn/14.18.1/img/champion/';
        const RUNE_IMAGE_URL = 'https://opgg-static.akamaized.net/meta/images/lol/14.10.1/perk/';
        const ITEM_IMAGE_URL = 'https://opgg-static.akamaized.net/meta/images/lol/14.13.1/item/';

        // 전역 변수 선언
        let apiKey = "";
        const matchList = localStorage.getItem('matchListResponse')?.split(',') || [];
        const summoner = localStorage.getItem("myName") || '';
        const myNickName = summoner.split('#')[0];
        let tierResponse = JSON.parse(localStorage.getItem("tierResponse") || '{}');

        // 유틸리티 함수
        const createElement = (tag, className, innerHTML) => {
            const element = document.createElement(tag);
            if (className) element.className = className;
            if (innerHTML) element.innerHTML = innerHTML;
            return element;
        };

        // 메인 함수
        async function initializePage() {
            try {
                apiKey = await getRiotApiKey();
                console.log("API Key Retrieved:", apiKey);
                updateProfileInfo();
                await getMatchDetails();
                log_in();
            } catch (error) {
                console.error("Error initializing page:", error);
                // 에러 처리 로직 (예: 사용자에게 에러 메시지 표시)
            }
        }

        function updateProfileInfo() {
            const profile = document.getElementById("top_text");
            if (!profile) return;
            
            profile.innerHTML = `
                ${summoner}<br>
                ${tierResponse.tier} ${tierResponse.rank}<br>
                ${tierResponse.leaguPoints} LP<br>
                ${tierResponse.wins}승 ${tierResponse.losses}패
            `;
        }

        async function getMatchDetails() {
            const matchHistoryContainer = document.getElementById("right");
            if (!matchHistoryContainer) return;

            matchHistoryContainer.innerHTML = ''; // Clear existing content

            for (let i = 0; i < Math.min(10, matchList.length); i++) {
                try {
                    const detail = await fetchMatchDetail(matchList[i]);
                    const matchElement = createMatchHistoryElement(detail, i);
                    matchHistoryContainer.appendChild(matchElement);
                } catch (error) {
                    console.error(`Error fetching match ${i} details:`, error);
                    // 에러 처리 로직 (예: 해당 매치 정보를 건너뛰고 계속 진행)
                }
            }
        }

        async function fetchMatchDetail(matchId) {
            const response = await fetch(`${API_BASE_URL}${matchId}?api_key=${apiKey}`);
            if (!response.ok) throw new Error('Network response was not ok');
            return await response.json();
        }

        function createMatchHistoryElement(detail, index) {
            const matchElement = createElement('div', 'matchHistory');
            matchElement.onclick = () => checkMatchInfo(index);

            // ... (매치 정보 UI 생성 로직)

            return matchElement;
        }

        // 이벤트 리스너
        window.onload = initializePage;

        // ... (기타 필요한 함수들)

        async function checkMatchInfo(id) {
            try {
                const detail = await fetchMatchDetail(matchList[id]);
                displayMatchInfo(detail);
            } catch (error) {
                console.error('Error fetching match info:', error);
                // 에러 처리 로직 (예: 사용자에게 에러 메시지 표시)
            }
        }

        async function fetchMatchDetail(matchId) {
            const response = await fetch(`${API_BASE_URL}${matchId}?api_key=${apiKey}`);
            if (!response.ok) throw new Error('Network response was not ok');
            return await response.json();
        }

        function displayMatchInfo(detail) {
            const leftContainer = document.getElementById('left');
            if (!leftContainer) return;

            leftContainer.innerHTML = '';

            for (let i = 0; i < 10; i++) {
                const participant = detail.info.participants[i];
                const { kills, deaths, assists, riotIdGameName, riotIdTagline, totalDamageDealtToChampions, totalDamageTaken, championName } = participant;

                const itemNumbers = [0, 1, 2, 3, 4, 5, 6].map(num => participant[`item${num}`]);
                
                const playerChampImage = `${CHAMPION_IMAGE_URL}${championName}.png`;

                const playerInfoHtml = `
                    <table>
                        <tr>
                            <td colspan="2" class="first_info">${riotIdGameName}</td>
                            <td colspan="2" class="first_info">#${riotIdTagline}</td>
                            <td colspan="2" class="first_info">${kills}/${deaths}/${assists}</td>
                        </tr>
                        <tr>
                            <td><img src="${playerChampImage}" class="player_image" alt="${championName}"></td>
                            ${itemNumbers.map(itemNum => `
                                <td><img class="second_info" src="${ITEM_IMAGE_URL}${itemNum}.png" alt="Item ${itemNum}"></td>
                            `).join('')}
                        </tr>
                        <tr>
                            <td colspan="2">가한 피해량: ${totalDamageDealtToChampions}</td>
                            <td colspan="2">받은 피해량: ${totalDamageTaken}</td>
                        </tr>
                    </table>
                `;

                leftContainer.innerHTML += playerInfoHtml;
            }
        }

    </script>

    <style>
        #matchHistoryContainer {
            border: 1px solid black;
            width: 75%;
            height: auto;
            margin: auto;
            display: flex;
            margin-top: 2%;
            overflow-y: auto;
        }




        #matchHistoryContainer #left {
            border: 1px solid black;
            flex: 1;
            margin-right: 20px;
        }

        #matchHistoryContainer #right {
            flex: 2;

        }

        #left {
            border: 1px solid black;
        }


        #right {
            flex: 2;
            overflow-y: auto;
            /* 세로 스크롤이 필요한 경우 스크롤바를 표시합니다. */
            scrollbar-width: thin;
            /* 스크롤바 너비를 얇게 설정합니다. */
            height: 1000px;
        }

        /* 스크롤바의 스타일링 */
        #right::-webkit-scrollbar {
            width: 8px;
            /* 스크롤바 너비를 조정합니다. */
        }

        #right::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.3);
            /* 스크롤바 색상을 지정합니다. */
            border-radius: 4px;
            /* 스크롤바 모서리를 둥글게 만듭니다. */
        }


        #top_container {
            border: 2px solid rgb(249, 156, 171);
            border-radius: 15px;
            padding: 20px;
            margin: auto;
            margin-top: 2%;
            width: 45%;
            height: 300px;
            text-align: center;
            font-size: 30px;
        }

        #top_text {
            margin-top: 5%;
            margin-right: 40%;
        }




        .matchHistory {
            background-color: #3D3D3D;
            display: flex;
            justify-content: space-between;
            color: white;
            border: 2px solid rgb(249, 156, 171);
            border-radius: 10px;
            margin: 5px;
            margin-bottom: 15px;
            padding: 0px;
            z-index: -1;
            cursor: pointer;
        }

        .player_red_team {
            color: rgb(255, 255, 255);
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player_blue_team {

            color: rgb(255, 255, 255);
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: -10;
        }

        .champ_container {
            margin-left: 0;
            width: 30%;
            height: 7%;
            float: left;
        }

        .champ_container2 {
            margin-top: 5%;
            margin-right: 0;
            margin-left: 5%;
            width: 17%;
            float: right;
            text-align: center;
        }



        .champ_container2>div {
            border: 2px solid rgb(249, 156, 171);

        }

        .match_info {
            padding: 6px;
            width: 45%;
            font-size: 18px;
            color: rgb(255, 255, 255);
            margin-bottom: 5%;
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
        }

        .my_profile {
            display: flex;
            justify-content: center;
            width: 300px;
            margin-left: 40px;
        }

        .rune_image {
            border: 1px solid rgb(249, 156, 171);
            border-radius: 50%;
            width: 55px;
            height: 55px;
            margin-top: 1%;
            margin-left: 10px;
            margin-right: 10px;
        }

        .profile_image {
            display: block;
            position: relative;
            width: 65px;
            /* 이미지의 너비 */
            height: 65px;
            /* 이미지의 높이 */
            border-radius: 50%;
            /* 원형으로 만들기 위해 50%로 설정 */
            /* 넘치는 부분을 숨김 */
            z-index: 0;
            margin-top: 1%;
        }


        .kda {
            font-family: fantasy;
            margin-left: 4%;
            display: block;

            font-size: 115%;

            color: rgba(255, 255, 255, 0.804);
        }

        .player_list {
            display: flex;
            justify-content: space-around;

            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 30%;

            border-left: 1px solid gray;
            border-radius: 7px;
        }



        .player_blue_team::selection {
            background-color: plum;
        }

        .player_red_team::selection {
            background-color: plum;
        }

        .first_info {
            color: 2px solid rgb(249, 156, 171);
            font-size: 15px;
            font-weight: bold;
        }

        .second_info {
            border: 2px solid rgb(249, 156, 171);
            width: 35px;
            height: 35px;
        }

        .player_image {
            border: 1px solid rgb(249, 156, 171);
            border-radius: 55px;
            width: 40px;
            height: 40px;
        }

        .spell_image {
            display: inline;
            padding: 2px;
            border: 1px solid rgb(249, 156, 171);
            width: 29px;
            height: 29px;
        }

        .spell_image_box {
            width: 100px;
        }
    </style>

</head>

<body>
    <div class="top">

        <div class="menu">
            <div class="container container-one" onclick="location.href='../index.html'">
                <button>
                    Main
                </button>
            </div>

            <div class="container container-one" onclick="location.href='../matchHistory/matchHistory.html'">
                <button>
                    전적검색
                </button>
            </div>

            <div class="container container-one" onclick="location.href='../findDuo/findDuo.html'">
                <button>
                    듀오찾기
                </button>
            </div>

            <div class="container container-one" onclick="location.href='../community/community.html'">
                <button>
                    커뮤니티
                </button>
            </div>

            <div class="container container-one" onclick="location.href='../ranking/ranking.html'">
                <button>
                    랭킹
                </button>
            </div>
            <span class="top_right">
                <div class="container container-one" onclick="location.href='../request/request.html'">
                    <button>
                        요청목록

                    </button>
                </div>

                <div class="container container-one" onclick = "checkLogin()">
                        로그인

                </div>

                <div class="container container-one" onclick="location.href='../signUp/signUp.html'">
                    <button>
                        회원가입

                    </button>
                </div>

                <div class="container container-one" onclick="location.href='../myPage/myPage.html'">
                    <button>
                        마이페이지

                    </button>
                </div>
            </span>
        </div>
    </div>

    <div class="middle">
        <div id="top_container">
            <div id="top_text">Top</div>
        </div>
        <div id="matchHistoryContainer">
            <div id="left">

            </div>
            <div id="right">
                <div class="matchHistory" onclick="checkMatchInfo(0)"></div>
                <div class="matchHistory" onclick="checkMatchInfo(1)"></div>
                <div class="matchHistory" onclick="checkMatchInfo(2)"></div>
                <div class="matchHistory" onclick="checkMatchInfo(3)"></div>
                <div class="matchHistory" onclick="checkMatchInfo(4)"></div>
                <div class="matchHistory" onclick="checkMatchInfo(5)"></div>
                <div class="matchHistory" onclick="checkMatchInfo(6)"></div>
                <div class="matchHistory" onclick="checkMatchInfo(7)"></div>
                <div class="matchHistory" onclick="checkMatchInfo(8)"></div>
                <div class="matchHistory" onclick="checkMatchInfo(9)"></div>
            </div>
        </div>
    </div>
    <div class="bottom">
        <div class="pink">
            <div></div>
        </div>
    </div>
</body>

</html>