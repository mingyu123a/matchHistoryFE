<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="../main.css" rel="stylesheet">
    <link href="../signUp/signUp.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="../login.js"></script>
    <script>
        // 마이페이지 정보를 요청하고 표시하는 함수
        async function mypageRequest() {
            try {
                // 세션 스토리지에서 토큰 데이터 가져오기
                const tokenData = JSON.parse(sessionStorage.getItem('accessToken'));
                if (!tokenData || !tokenData.accessToken) {
                    throw new Error('로그인이 필요합니다.');
                }
                const accessToken = tokenData.accessToken;

                // AJAX 요청 보내기
                const result = await $.ajax({
                    url: "https://findd.findduo.site/mypage/mypage",
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                // 응답 결과를 로컬 스토리지에 저장
                localStorage.setItem("matchListResponse", JSON.stringify(result));

                // 프로필 정보 업데이트
                updateProfileInfo(result);

                // 모스트 챔피언 정보 업데이트
                updateMostChampions(result);
            } catch (error) {
                console.error("마이페이지 정보 요청 실패:", error);
                alert("마이페이지 정보를 불러오는데 실패했습니다. 로그인 상태를 확인해주세요.");
                window.location.href = '../index.html'; // 메인 페이지로 리다이렉트
            }
        }

        // 프로필 정보를 업데이트하는 함수
        function updateProfileInfo(data) {
            const infoFields = [
                { key: 'riotId', label: 'Riot ID' },
                { key: 'email', label: 'email' },
                { key: 'tier', label: 'tier' },
                { key: 'rank', label: 'rank' },
                { key: 'leaguePoints', label: 'leaguePoints', suffix: 'P' },
                { key: 'wins', label: 'wins', suffix: '승' },
                { key: 'losses', label: 'losses', suffix: '패' }
            ];

            infoFields.forEach((field, index) => {
                const element = document.getElementsByClassName("myPage_info")[index];
                element.innerHTML = `<strong>${field.label}:</strong> ${data[field.key]}${field.suffix || ''}`;
            });
        }

        // 모스트 챔피언 정보를 업데이트하는 함수
        function updateMostChampions(data) {
            const wrappedBox = document.getElementById("wrapped_box");
            let champHtml = '';

            for (let i = 0; i < 3; i++) {
                const imageUrl = `https://lolcdn.darkintaqt.com/cdn/champion/${data.championId[i]}/tile`;
                const points = Number(data.championPoints[i]).toLocaleString();
                champHtml += `
                    <div class="champ-stats">
                        <img src="${imageUrl}" alt="Champion ${i+1}" width="46px">
                        <div class="num">${points}</div>
                    </div>`;
            }

            wrappedBox.innerHTML = champHtml;
        }

        // 페이지 로드 시 실행될 함수
        async function initPage() {
            await checkLoginStatus(); // login.js에 정의된 함수
            await mypageRequest();
        }

        // DOMContentLoaded 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
    <style>
        h1 {
            text-align: center;
            color: #333;
        }

        .profile-box {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            max-width: 600px;
            margin: 50px auto;
        }

        .profile-box p {
            margin: 10px 0;
            font-size: 16px;
            color: #555;
        }

        .profile-box strong {
            color: #000;
        }

        .group {
            margin-bottom: 20px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
        }

        #wrapped_box {
            display: flex;
            justify-content: space-around;
        }

        img {
            border: 3px solid black;
        }

        .champ-stats>div {
            color: gray;
            font-size: 15px;
            font-weight: bold;
        }

        #mostChampTitle {
            font-size: 17px;
            font-weight: 700;
            color: #000;
            text-align: center;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <div class="top">

        <div class="menu">
            <div class="container container-one" onclick="location.href='../index.html'">
                <button>
                    Main

                </button>
            </div>

            <div class="container container-one" onclick="location.href='../matchHistory/matchHistory.html'">
                <button>
                    전적검색

                </button>
            </div>

            <div class="container container-one" onclick="location.href='../findDuo/findDuo.html'">
                <button>
                    듀오찾기

                </button>
            </div>

            <div class="container container-one" onclick="location.href='../community/community.html'">
                <button>
                    커뮤니티

                </button>
            </div>

            <div class="container container-one" onclick="location.href='../ranking/ranking.html'">
                <button>
                    랭킹

                </button>
            </div>
            <span class="top_right">
                <div class="container container-one" onclick="location.href='../request/request.html'">
                    <button>
                        요청목록
    

                    </button>
                </div>
                <div class="container container-one" onclick="handleLoginLogout()">
                    <button class="log_in_out_btn">
                      로그인
  
                    </button>
                  </div>

                <div class="container container-one" onclick="location.href='../signUp/signUp.html'">
                    <button>
                        회원가입
    
                    </button>
                </div>

                <div class="container container-one" onclick="location.href='../myPage/myPage.html'">
                    <button>
                        마이페이지
    
                    </button>
                </div>
            </span>
        </div>
    </div>
    <div class="middle">
        <div class="profile-box">
            <h1>My Page</h1>
            <div class="group">
                <p class="myPage_info"></p>
                <p class="myPage_info"></p>
            </div>

            <div class="group">
                <p class="myPage_info"></p>
                <p class="myPage_info"></p>
                <p class="myPage_info"></p>
            </div>
            <div class="group">
                <p class="myPage_info"></p>
                <p class="myPage_info"></p>
            </div>
            <div id="mostChampTitle">모스트 챔피언</div>

            <div id="wrapped_box">
                <div class="champ-stats">
                    <img src="https://lolcdn.darkintaqt.com/cdn/champion/${}/tile" alt="" width="46px">
                    <div class="num"></div>
                </div>
                <div class="champ-stats">
                    <img src="https://lolcdn.darkintaqt.com/cdn/champion/${}/tile" alt="" width="46px">
                    <div class="num"></div>
                </div>
                <div class="champ-stats">
                    <img src="https://lolcdn.darkintaqt.com/cdn/champion/${}/tile" alt="" width="46px">
                    <div class="num"></div>
                </div>

            </div>
        </div>
    </div>

    <div class="bottom">
        <div class="pink">
            <div></div>
        </div>
    </div>
</body>

</html>